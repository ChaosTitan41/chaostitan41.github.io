<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Paneli | CHAOSTITAN41</title>
    <link rel="icon" type="image/ico" href="image/favicon.ico">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ===== DEIN COOLES FILTER.HTML DESIGN ===== */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background: #000 url('bg.png') no-repeat center center fixed; 
            background-size: cover; 
            color: #fff; 
            font-family: 'Impact', sans-serif; 
            text-align: center; 
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .logo-container {
            position: fixed;
            top: 0; 
            left: 0; 
            right: 0;
            padding: 15px;
            z-index: 1000;
            text-align: center;
        }
        
        .logo-link {
            display: inline-block;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .logo-img { 
            width: 100%; 
            max-width: 180px; 
            filter: drop-shadow(0 0 10px #000);
            transition: all 0.3s ease;
        }
        
        .logo-link:hover .logo-img {
            filter: drop-shadow(0 0 25px #ff0000) !important;
            transform: scale(1.05) !important;
        }
        
        .main-wrapper {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            max-width: 1600px;
            margin: 0 auto;
            padding: 140px 20px 20px;
        }
        
        .container { 
            flex: 0 1 1100px; 
        }
        
        .btn-container { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            justify-items: center;
        }
        
        .filter-btn { 
            width: 100%;
            max-width: 200px;
            border-radius: 16px;
            border: 2px solid rgba(255, 0, 0, 0.3); 
            cursor: pointer; 
            transition: 0.3s; 
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            position: relative;
            overflow: hidden;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .filter-btn:hover:not(:disabled) {
            transform: scale(1.05);
            border-color: #ff0000;
            box-shadow: 0 0 25px rgba(255, 0, 0, 0.5);
        }

        .btn-image-container {
            width: 100%;
            aspect-ratio: 9/16;
            overflow: hidden;
        }
        
        .btn-image { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block; 
        }
        
        .btn-name {
            padding: 10px 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid rgba(255, 0, 0, 0.3);
        }
        
        .btn-click-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff0000;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(255,0,0,0.5);
            z-index: 10;
        }
        
        .top10-sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 20px;
            border: 2px solid rgba(255, 0, 0, 0.5);
            padding: 20px;
            backdrop-filter: blur(15px);
            position: sticky;
            top: 140px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .top10-title {
            color: #ff0000;
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-transform: uppercase;
            text-align: center;
        }
        
        .top10-item {
            display: flex; 
            align-items: center; 
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px; 
            margin-bottom: 8px; 
            border-radius: 12px;
            border-left: 4px solid #ff0000;
        }

        .top10-thumb { 
            width: 45px; 
            height: 45px; 
            border-radius: 6px; 
            object-fit: cover; 
        }
        
        .top10-number {
            color: #ff0000;
            font-weight: bold;
            width: 25px;
            text-align: center;
        }
        
        .top10-name {
            flex: 1;
            text-align: left;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .top10-count {
            background: #ff0000;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-message { 
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #ff0000;
            border-radius: 10px;
            color: #ffaa00; 
            font-size: 1.2rem; 
            display: none; 
            z-index: 1000;
            white-space: nowrap;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }
        
        .status-message.success { color: #00ff00; }
        .status-message.error { color: #ff6666; }
        
        .back-link { 
            display: inline-block; 
            margin-top: 40px; 
            color: #888; 
            text-decoration: none; 
            padding: 12px 30px; 
            border: 2px solid #333; 
            border-radius: 12px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            color: #ff0000;
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #ff0000;
            font-size: 1.5rem;
            grid-column: 1 / -1;
        }

        .no-buttons {
            text-align: center;
            padding: 50px;
            color: #888;
            font-size: 1.2rem;
            grid-column: 1 / -1;
        }

        @media (max-width: 1200px) { 
            .main-wrapper { 
                flex-direction: column; 
                align-items: center;
                gap: 30px;
            } 
            
            .top10-sidebar { 
                width: 100%; 
                max-width: 1100px; 
                position: static; 
                max-height: none;
                order: -1;
            }
            
            .btn-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .logo-img {
                max-width: 140px;
            }
            
            .main-wrapper {
                padding: 120px 15px 20px;
            }
            
            .btn-container { 
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
            
            .filter-btn {
                max-width: 150px;
                border-radius: 12px;
            }
            
            .btn-name {
                font-size: 0.8rem;
                padding: 8px 3px;
            }
            
            .top10-sidebar {
                padding: 15px;
            }
            
            .top10-item {
                padding: 6px;
            }
            
            .top10-thumb {
                width: 40px;
                height: 40px;
            }
            
            .status-message {
                font-size: 1rem;
                padding: 12px 25px;
                bottom: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .btn-container { 
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .filter-btn {
                max-width: none;
                width: 100%;
                border-radius: 10px;
            }
            
            .btn-name {
                font-size: 0.75rem;
            }
            
            .back-link {
                width: 100%;
                margin-top: 30px;
            }
        }
    </style>
</head>
<body>

    <div class="logo-container">
        <a href="index.html" class="logo-link">
            <img src="logo.png" class="logo-img" alt="CHAOSTITAN41">
        </a>
    </div>

    <div class="main-wrapper">
        <div class="container">
            <h1 style="color:#ff0000; margin-bottom:30px; text-align:left;">üéÆ BUTTON PANEL</h1>
            <div class="btn-container" id="buttonGrid">
                <div class="loading">Buttons werden geladen...</div>
            </div>
        </div>
        
        <div class="top10-sidebar">
            <div class="top10-title">üî• TOP 10 BUTTONS</div>
            <div id="top10List">Laden...</div>
        </div>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <script>
        // ============================================
        // FIREBASE KONFIGURATION (deine bestehende!)
        // ============================================
        const firebaseConfig = { 
            apiKey: "AIzaSyC4fo69Q0sf7DVgJSDhojAPzLsQ7SDu6cg", 
            authDomain: "chaostitan41-website.firebaseapp.com", 
            databaseURL: "https://chaostitan41-website-default-rtdb.europe-west1.firebasedatabase.app", 
            projectId: "chaostitan41-website", 
            storageBucket: "chaostitan41-website.firebasestorage.app", 
            messagingSenderId: "553158677453", 
            appId: "1:553158677453:web:2cad39890ffdedb98aaa84" 
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // ============================================
        // KONFIGURATION ‚Äì DEINE FESTE NGROK-DOMAIN!
        // ============================================
        const API_BASE_URL = 'https://aditya-unfeudal-brock.ngrok-free.dev'; // ‚úÖ Einmal eintragen ‚Äì f√ºr immer g√ºltig!
        
        // ============================================
        // GLOBALE VARIABLEN
        // ============================================
        let currentButtons = [];
        let buttonClickCounts = {};
        
        // ============================================
        // HILFSFUNKTION: Lade Bild mit Header als Blob und gib ObjectURL zur√ºck
        // ============================================
        async function loadThumbnailAsBlob(thumbUrl) {
            try {
                const response = await fetch(thumbUrl, {
                    headers: {
                        'ngrok-skip-browser-warning': 'true' // F√ºr Ngrok (optional, aber harmlos)
                    }
                });
                if (!response.ok) throw new Error('Bild konnte nicht geladen werden');
                const blob = await response.blob();
                return URL.createObjectURL(blob);
            } catch (error) {
                console.warn('Fehler beim Laden des Thumbnails:', thumbUrl, error);
                return null;
            }
        }
        
        // ============================================
        // BUTTONS LADEN (von ChaosBOT)
        // ============================================
        async function loadButtons() {
            const grid = document.getElementById('buttonGrid');
            
            try {
                const response = await fetch(API_BASE_URL + '/api/buttons', {
                    headers: {
                        'ngrok-skip-browser-warning': 'true'
                    }
                });
                const data = await response.json();
                
                if (!data.buttons || data.buttons.length === 0) {
                    grid.innerHTML = '<div class="no-buttons">Noch keine Buttons vorhanden.</div>';
                    return;
                }
                
                currentButtons = data.buttons;
                
                // Lade Klick-Statistiken aus Firebase
                await loadClickStats();
                
                // Zeige Buttons an (async, weil wir Bilder laden m√ºssen)
                await renderButtons(currentButtons);
                
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                grid.innerHTML = `
                    <div class="no-buttons">
                        ‚ùå ChaosBOT nicht erreichbar<br>
                        <small style="color:#666;">Starte ChaosBOT und Ngrok neu</small>
                    </div>
                `;
            }
        }
        
        async function renderButtons(buttons) {
            const grid = document.getElementById('buttonGrid');
            grid.innerHTML = ''; // leeren
            
            const fallbackUrl = 'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExYzVhNWNxZGw1eW96NXZuZzkwbzRmdnE1eWYxcHZoaHM1YWs0ZzNtbyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/L556NMrX2yWiAtDPqf/giphy.gif';
            
            const buttonPromises = buttons.map(async (button) => {
                const clickCount = buttonClickCounts[button.id] || 0;
                
                let thumbUrl = fallbackUrl;
                if (button.thumbnailFile) {
                    const loadedUrl = await loadThumbnailAsBlob(API_BASE_URL + '/thumbnails/' + button.thumbnailFile);
                    if (loadedUrl) thumbUrl = loadedUrl;
                }
                
                const buttonDiv = document.createElement('button');
                buttonDiv.className = 'filter-btn';
                buttonDiv.setAttribute('onclick', `triggerButton('${button.id}', '${button.name}')`);
                
                if (clickCount > 0) {
                    const countSpan = document.createElement('div');
                    countSpan.className = 'btn-click-count';
                    countSpan.textContent = clickCount;
                    buttonDiv.appendChild(countSpan);
                }
                
                const imgContainer = document.createElement('div');
                imgContainer.className = 'btn-image-container';
                
                const img = document.createElement('img');
                img.className = 'btn-image';
                img.src = thumbUrl;
                img.alt = button.name;
                img.onerror = function() { this.src = fallbackUrl; };
                
                imgContainer.appendChild(img);
                buttonDiv.appendChild(imgContainer);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'btn-name';
                nameDiv.textContent = button.name;
                buttonDiv.appendChild(nameDiv);
                
                return buttonDiv;
            });
            
            const buttonElements = await Promise.all(buttonPromises);
            buttonElements.forEach(el => grid.appendChild(el));
        }
        
        // ============================================
        // KLICK-STATISTIK (Firebase)
        // ============================================
        async function loadClickStats() {
            return new Promise((resolve) => {
                db.ref('buttonStats').once('value', (snap) => {
                    const stats = snap.val() || {};
                    buttonClickCounts = {};
                    
                    Object.keys(stats).forEach(buttonId => {
                        const buttonData = stats[buttonId];
                        if (buttonData && typeof buttonData === 'object') {
                            buttonClickCounts[buttonId] = Object.keys(buttonData).length;
                        }
                    });
                    
                    updateTop10();
                    resolve();
                });
            });
        }
        
        async function saveClickToFirebase(buttonId) {
            const timestamp = Date.now();
            const newClickRef = db.ref('buttonStats/' + buttonId).push();
            await newClickRef.set({
                timestamp: timestamp,
                date: new Date().toISOString()
            });
        }
        
        // ============================================
        // TOP 10 LISTE (mit Thumbnails)
        // ============================================
        async function updateTop10() {
            const listDiv = document.getElementById('top10List');
            
            const clickArray = Object.entries(buttonClickCounts).map(([id, count]) => {
                const button = currentButtons.find(b => b.id === id);
                return {
                    id: id,
                    name: button ? button.name : id,
                    count: count,
                    thumbnailFile: button?.thumbnailFile
                };
            });
            
            const sorted = clickArray.sort((a, b) => b.count - a.count).slice(0, 10);
            
            if (sorted.length === 0) {
                listDiv.innerHTML = '<div style="color:#888; text-align:center;">Noch keine Klicks</div>';
                return;
            }
            
            const fallbackUrl = 'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExYzVhNWNxZGw1eW96NXZuZzkwbzRmdnE1eWYxcHZoaHM1YWs0ZzNtbyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/L556NMrX2yWiAtDPqf/giphy.gif';
            
            const top10Promises = sorted.map(async (item, index) => {
                let thumbUrl = fallbackUrl;
                if (item.thumbnailFile) {
                    const loadedUrl = await loadThumbnailAsBlob(API_BASE_URL + '/thumbnails/' + item.thumbnailFile);
                    if (loadedUrl) thumbUrl = loadedUrl;
                }
                
                const medalColor = index === 0 ? '#ffd700' : (index === 1 ? '#c0c0c0' : (index === 2 ? '#cd7f32' : '#ff0000'));
                
                return `
                    <div class="top10-item">
                        <span class="top10-number" style="color:${medalColor};">${index+1}</span>
                        <img src="${thumbUrl}" class="top10-thumb" alt="${item.name}" onerror="this.src='${fallbackUrl}'">
                        <div class="top10-name">${item.name}</div>
                        <span class="top10-count">${item.count}</span>
                    </div>
                `;
            });
            
            const top10Html = (await Promise.all(top10Promises)).join('');
            listDiv.innerHTML = top10Html;
        }
        
        // ============================================
        // BUTTON TRIGGERN
        // ============================================
        async function triggerButton(buttonId, buttonName) {
            const statusDiv = document.getElementById('statusMessage');
            
            try {
                statusDiv.style.display = 'block';
                statusDiv.className = 'status-message';
                statusDiv.innerHTML = '‚è≥ Button wird ausgel√∂st...';
                
                const response = await fetch(API_BASE_URL + '/api/trigger/' + buttonId, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    body: JSON.stringify({ force: false, source: 'web_buttons' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await saveClickToFirebase(buttonId);
                    await loadClickStats();
                    await renderButtons(currentButtons);
                    
                    statusDiv.innerHTML = `‚úÖ ${buttonName} wurde ausgel√∂st!`;
                    statusDiv.classList.add('success');
                } else {
                    statusDiv.innerHTML = `‚ùå Fehler: ${data.error || 'Unbekannter Fehler'}`;
                    statusDiv.classList.add('error');
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Fehler:', error);
                statusDiv.innerHTML = '‚ùå ChaosBOT nicht erreichbar';
                statusDiv.classList.add('error');
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // ============================================
        // LIVE-UPDATES von Firebase
        // ============================================
        function setupFirebaseListener() {
            db.ref('buttonStats').on('value', async () => {
                await loadClickStats();
                await renderButtons(currentButtons);
            });
        }
        
        // ============================================
        // INITIALISIERUNG
        // ============================================
        window.onload = () => {
            loadButtons();
            setupFirebaseListener();
            
            // Alle 60 Sekunden Buttons neu laden (f√ºr neue Buttons in ChaosBOT)
            setInterval(loadButtons, 60000);
        };
    </script>
</body>
</html>
